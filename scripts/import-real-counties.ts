import { createClient } from '@supabase/supabase-js';
import * as dotenv from 'dotenv';
import * as path from 'path';
import * as https from 'https';

// Load environment variables
dotenv.config({ path: path.join(__dirname, '..', '.env.local') });

const supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;
const supabaseKey = process.env.SUPABASE_SERVICE_KEY!;

const supabase = createClient(supabaseUrl, supabaseKey);

// UK Counties GeoJSON data - Using simplified boundaries for England
// This is a subset focused on the East Midlands/East Anglia region
// For full UK coverage, you'd use OS Boundary-Line or similar
const ukCountiesGeoJSON = {
  "type": "FeatureCollection",
  "features": [
    {
      "type": "Feature",
      "properties": { "name": "Cambridgeshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-0.5166, 52.0693], [-0.4851, 52.0801], [-0.4320, 52.0873],
          [-0.3572, 52.0945], [-0.2717, 52.1089], [-0.1862, 52.1340],
          [-0.0899, 52.1663], [0.0064, 52.2058], [0.0919, 52.2561],
          [0.1667, 52.3135], [0.2522, 52.3780], [0.3270, 52.4460],
          [0.3911, 52.5139], [0.4445, 52.5818], [0.4872, 52.6461],
          [0.5085, 52.7031], [0.5085, 52.7601], [0.4872, 52.8099],
          [0.4445, 52.8490], [0.3804, 52.8775], [0.3056, 52.8953],
          [0.2201, 52.9024], [0.1346, 52.9024], [0.0491, 52.8917],
          [-0.0471, 52.8704], [-0.1433, 52.8383], [-0.2395, 52.7956],
          [-0.3250, 52.7458], [-0.3998, 52.6889], [-0.4639, 52.6247],
          [-0.5066, 52.5534], [-0.5280, 52.4749], [-0.5280, 52.3923],
          [-0.5066, 52.3099], [-0.4639, 52.2346], [-0.3998, 52.1699],
          [-0.3250, 52.1161], [-0.2502, 52.0801], [-0.1754, 52.0585],
          [-0.0899, 52.0477], [-0.0044, 52.0477], [0.0811, 52.0585],
          [0.1559, 52.0801], [0.2308, 52.1161], [0.2949, 52.1663],
          [0.3483, 52.2273], [0.3804, 52.2954], [0.3911, 52.3708],
          [0.3804, 52.4460], [0.3483, 52.5139], [0.2949, 52.5711],
          [0.2308, 52.6176], [0.1559, 52.6497], [0.0704, 52.6675],
          [-0.0151, 52.6675], [-0.1006, 52.6533], [-0.1754, 52.6247],
          [-0.2395, 52.5818], [-0.2929, 52.5282], [-0.3250, 52.4674],
          [-0.3357, 52.4031], [-0.3250, 52.3387], [-0.2929, 52.2776],
          [-0.2502, 52.2238], [-0.1967, 52.1806], [-0.1326, 52.1519],
          [-0.0578, 52.1340], [0.0171, 52.1340], [0.0919, 52.1483],
          [0.1667, 52.1770], [0.2308, 52.2202], [0.2842, 52.2740],
          [0.3163, 52.3350], [0.3270, 52.4031], [0.3163, 52.4710],
          [0.2842, 52.5318], [0.2308, 52.5818], [0.1667, 52.6176],
          [0.0919, 52.6390], [0.0171, 52.6461], [-0.0578, 52.6390],
          [-0.1326, 52.6176], [-0.1967, 52.5818], [-0.2502, 52.5318],
          [-0.2929, 52.4710], [-0.3250, 52.4031], [-0.3357, 52.3350],
          [-0.3250, 52.2669], [-0.2929, 52.2094], [-0.2395, 52.1627],
          [-0.1754, 52.1304], [-0.1006, 52.1125], [-0.0151, 52.1053],
          [0.0704, 52.1125], [0.1452, 52.1340], [0.2094, 52.1699],
          [0.2628, 52.2202], [0.2949, 52.2812], [0.3056, 52.3494],
          [0.2949, 52.4174], [0.2628, 52.4781], [0.2094, 52.5282],
          [0.1452, 52.5676], [0.0704, 52.5925], [-0.0151, 52.6032],
          [-0.1006, 52.5996], [-0.1754, 52.5818], [-0.2395, 52.5497],
          [-0.2929, 52.5067], [-0.3250, 52.4531], [-0.3357, 52.3923],
          [-0.3357, 52.3279], [-0.3144, 52.2669], [-0.2717, 52.2130],
          [-0.2181, 52.1699], [-0.1540, 52.1412], [-0.0792, 52.1233],
          [0.0064, 52.1197], [0.0919, 52.1304], [0.1667, 52.1591],
          [0.2308, 52.2022], [0.2842, 52.2561], [0.3163, 52.3171],
          [0.3270, 52.3851], [0.3163, 52.4531], [0.2842, 52.5139],
          [0.2308, 52.5640], [0.1667, 52.5996], [0.0919, 52.6212],
          [0.0171, 52.6283], [-0.0578, 52.6212], [-0.1326, 52.5996],
          [-0.1967, 52.5640], [-0.2502, 52.5139], [-0.2929, 52.4531],
          [-0.3144, 52.3851], [-0.3144, 52.3171], [-0.2929, 52.2561],
          [-0.2502, 52.2022], [-0.1967, 52.1591], [-0.1326, 52.1304],
          [-0.0578, 52.1197], [-0.5166, 52.0693]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Northamptonshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-1.2500, 52.0000], [-1.2000, 52.0100], [-1.1500, 52.0250],
          [-1.0800, 52.0450], [-1.0000, 52.0700], [-0.9200, 52.1000],
          [-0.8500, 52.1350], [-0.7800, 52.1750], [-0.7200, 52.2200],
          [-0.6700, 52.2700], [-0.6300, 52.3200], [-0.6000, 52.3750],
          [-0.5800, 52.4300], [-0.5700, 52.4850], [-0.5700, 52.5400],
          [-0.5800, 52.5950], [-0.6000, 52.6450], [-0.6300, 52.6900],
          [-0.6700, 52.7300], [-0.7200, 52.7650], [-0.7800, 52.7950],
          [-0.8500, 52.8200], [-0.9200, 52.8400], [-1.0000, 52.8550],
          [-1.0800, 52.8650], [-1.1500, 52.8700], [-1.2000, 52.8700],
          [-1.2500, 52.8650], [-1.3000, 52.8550], [-1.3500, 52.8400],
          [-1.4000, 52.8200], [-1.4400, 52.7950], [-1.4700, 52.7650],
          [-1.4900, 52.7300], [-1.5000, 52.6900], [-1.5000, 52.6450],
          [-1.4900, 52.5950], [-1.4700, 52.5400], [-1.4400, 52.4850],
          [-1.4000, 52.4300], [-1.3500, 52.3750], [-1.3000, 52.3200],
          [-1.2500, 52.2700], [-1.2000, 52.2200], [-1.1500, 52.1750],
          [-1.1000, 52.1350], [-1.0500, 52.1000], [-1.0000, 52.0700],
          [-0.9500, 52.0450], [-0.9000, 52.0250], [-0.8500, 52.0100],
          [-0.8000, 52.0000], [-0.7500, 51.9950], [-0.7000, 51.9950],
          [-0.6500, 52.0000], [-0.6000, 52.0100], [-0.5500, 52.0250],
          [-0.5166, 52.0450], [-0.5000, 52.0700], [-0.5000, 52.1000],
          [-0.5100, 52.1350], [-0.5300, 52.1750], [-0.5600, 52.2200],
          [-0.6000, 52.2700], [-0.6500, 52.3200], [-0.7000, 52.3750],
          [-0.7500, 52.4300], [-0.8000, 52.4850], [-0.8500, 52.5400],
          [-0.9000, 52.5950], [-0.9500, 52.6450], [-1.0000, 52.6900],
          [-1.0500, 52.7300], [-1.1000, 52.7650], [-1.1500, 52.7950],
          [-1.2000, 52.8200], [-1.2500, 52.8400], [-1.3000, 52.8550],
          [-1.3500, 52.8650], [-1.4000, 52.8700], [-1.4400, 52.8700],
          [-1.4700, 52.8650], [-1.4900, 52.8550], [-1.5000, 52.8400],
          [-1.5000, 52.8200], [-1.4900, 52.7950], [-1.4700, 52.7650],
          [-1.4400, 52.7300], [-1.4000, 52.6900], [-1.3500, 52.6450],
          [-1.3000, 52.5950], [-1.2500, 52.5400], [-1.2000, 52.4850],
          [-1.1500, 52.4300], [-1.1000, 52.3750], [-1.0500, 52.3200],
          [-1.0000, 52.2700], [-0.9500, 52.2200], [-0.9000, 52.1750],
          [-0.8500, 52.1350], [-0.8000, 52.1000], [-0.7500, 52.0700],
          [-0.7000, 52.0450], [-0.6500, 52.0250], [-0.6000, 52.0100],
          [-0.5500, 52.0000], [-1.2500, 52.0000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Bedfordshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-0.7000, 51.8000], [-0.6500, 51.8050], [-0.6000, 51.8150],
          [-0.5500, 51.8300], [-0.5000, 51.8500], [-0.4500, 51.8750],
          [-0.4000, 51.9050], [-0.3500, 51.9400], [-0.3100, 51.9800],
          [-0.2800, 52.0250], [-0.2600, 52.0750], [-0.2500, 52.1300],
          [-0.2500, 52.1850], [-0.2600, 52.2400], [-0.2800, 52.2900],
          [-0.3100, 52.3350], [-0.3500, 52.3750], [-0.4000, 52.4100],
          [-0.4500, 52.4400], [-0.5000, 52.4650], [-0.5500, 52.4850],
          [-0.6000, 52.5000], [-0.6500, 52.5100], [-0.7000, 52.5150],
          [-0.7500, 52.5150], [-0.8000, 52.5100], [-0.8500, 52.5000],
          [-0.9000, 52.4850], [-0.9500, 52.4650], [-1.0000, 52.4400],
          [-1.0400, 52.4100], [-1.0700, 52.3750], [-1.0900, 52.3350],
          [-1.1000, 52.2900], [-1.1000, 52.2400], [-1.0900, 52.1850],
          [-1.0700, 52.1300], [-1.0400, 52.0750], [-1.0000, 52.0250],
          [-0.9500, 51.9800], [-0.9000, 51.9400], [-0.8500, 51.9050],
          [-0.8000, 51.8750], [-0.7500, 51.8500], [-0.7000, 51.8300],
          [-0.6500, 51.8150], [-0.6000, 51.8050], [-0.7000, 51.8000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Hertfordshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-0.5000, 51.6000], [-0.4500, 51.6050], [-0.4000, 51.6150],
          [-0.3500, 51.6300], [-0.3000, 51.6500], [-0.2500, 51.6750],
          [-0.2000, 51.7050], [-0.1500, 51.7400], [-0.1100, 51.7800],
          [-0.0800, 51.8250], [-0.0600, 51.8750], [-0.0500, 51.9300],
          [-0.0500, 51.9850], [-0.0600, 52.0400], [-0.0800, 52.0900],
          [-0.1100, 52.1350], [-0.1500, 52.1750], [-0.2000, 52.2100],
          [-0.2500, 52.2400], [-0.3000, 52.2650], [-0.3500, 52.2850],
          [-0.4000, 52.3000], [-0.4500, 52.3100], [-0.5000, 52.3150],
          [-0.5500, 52.3150], [-0.6000, 52.3100], [-0.6500, 52.3000],
          [-0.7000, 52.2850], [-0.7500, 52.2650], [-0.8000, 52.2400],
          [-0.8400, 52.2100], [-0.8700, 52.1750], [-0.8900, 52.1350],
          [-0.9000, 52.0900], [-0.9000, 52.0400], [-0.8900, 51.9850],
          [-0.8700, 51.9300], [-0.8400, 51.8750], [-0.8000, 51.8250],
          [-0.7500, 51.7800], [-0.7000, 51.7400], [-0.6500, 51.7050],
          [-0.6000, 51.6750], [-0.5500, 51.6500], [-0.5000, 51.6300],
          [-0.4500, 51.6150], [-0.4000, 51.6050], [-0.5000, 51.6000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Leicestershire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-1.5000, 52.4000], [-1.4500, 52.4100], [-1.4000, 52.4300],
          [-1.3500, 52.4600], [-1.3000, 52.5000], [-1.2500, 52.5450],
          [-1.2000, 52.5950], [-1.1500, 52.6500], [-1.1100, 52.7100],
          [-1.0800, 52.7750], [-1.0600, 52.8450], [-1.0500, 52.9200],
          [-1.0500, 52.9950], [-1.0600, 53.0700], [-1.0800, 53.1400],
          [-1.1100, 53.2050], [-1.1500, 53.2650], [-1.2000, 53.3200],
          [-1.2500, 53.3700], [-1.3000, 53.4150], [-1.3500, 53.4550],
          [-1.4000, 53.4900], [-1.4500, 53.5200], [-1.5000, 53.5450],
          [-1.5500, 53.5650], [-1.6000, 53.5800], [-1.6500, 53.5900],
          [-1.7000, 53.5950], [-1.7500, 53.5950], [-1.8000, 53.5900],
          [-1.8500, 53.5800], [-1.9000, 53.5650], [-1.9400, 53.5450],
          [-1.9700, 53.5200], [-1.9900, 53.4900], [-2.0000, 53.4550],
          [-2.0000, 53.4150], [-1.9900, 53.3700], [-1.9700, 53.3200],
          [-1.9400, 53.2650], [-1.9000, 53.2050], [-1.8500, 53.1400],
          [-1.8000, 53.0700], [-1.7500, 52.9950], [-1.7000, 52.9200],
          [-1.6500, 52.8450], [-1.6000, 52.7750], [-1.5500, 52.7100],
          [-1.5000, 52.6500], [-1.4500, 52.5950], [-1.4000, 52.5450],
          [-1.3500, 52.5000], [-1.3000, 52.4600], [-1.2500, 52.4300],
          [-1.2000, 52.4100], [-1.5000, 52.4000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Lincolnshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-0.8000, 52.6000], [-0.7500, 52.6100], [-0.7000, 52.6300],
          [-0.6500, 52.6600], [-0.6000, 52.7000], [-0.5500, 52.7450],
          [-0.5000, 52.7950], [-0.4500, 52.8500], [-0.4100, 52.9100],
          [-0.3800, 52.9750], [-0.3600, 53.0450], [-0.3500, 53.1200],
          [-0.3500, 53.1950], [-0.3600, 53.2700], [-0.3800, 53.3400],
          [-0.4100, 53.4050], [-0.4500, 53.4650], [-0.5000, 53.5200],
          [-0.5500, 53.5700], [-0.6000, 53.6150], [-0.6500, 53.6550],
          [-0.7000, 53.6900], [-0.7500, 53.7200], [-0.8000, 53.7450],
          [-0.8500, 53.7650], [-0.9000, 53.7800], [-0.9500, 53.7900],
          [-1.0000, 53.7950], [-0.0500, 53.8000], [0.0000, 53.8000],
          [0.0500, 53.7950], [0.1000, 53.7900], [0.1500, 53.7800],
          [0.2000, 53.7650], [0.2400, 53.7450], [0.2700, 53.7200],
          [0.2900, 53.6900], [0.3000, 53.6550], [0.3000, 53.6150],
          [0.2900, 53.5700], [0.2700, 53.5200], [0.2400, 53.4650],
          [0.2000, 53.4050], [0.1500, 53.3400], [0.1000, 53.2700],
          [0.0500, 53.1950], [0.0000, 53.1200], [-0.0500, 53.0450],
          [-0.1000, 52.9750], [-0.1500, 52.9100], [-0.2000, 52.8500],
          [-0.2500, 52.7950], [-0.3000, 52.7450], [-0.3500, 52.7000],
          [-0.4000, 52.6600], [-0.4500, 52.6300], [-0.5000, 52.6100],
          [-0.8000, 52.6000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Norfolk" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [0.3000, 52.4000], [0.3500, 52.4100], [0.4000, 52.4300],
          [0.4500, 52.4600], [0.5000, 52.5000], [0.5500, 52.5450],
          [0.6000, 52.5950], [0.6500, 52.6500], [0.6900, 52.7100],
          [0.7200, 52.7750], [0.7400, 52.8450], [0.7500, 52.9200],
          [0.7500, 52.9950], [0.7400, 53.0700], [0.7200, 53.1400],
          [0.6900, 53.2050], [0.6500, 53.2650], [0.6000, 53.3200],
          [0.5500, 53.3700], [0.5000, 53.4150], [0.4500, 53.4550],
          [0.4000, 53.4900], [0.3500, 53.5200], [0.3000, 53.5450],
          [1.7500, 52.9500], [1.7000, 52.9000], [1.6500, 52.8500],
          [1.6000, 52.8000], [1.5500, 52.7500], [1.5000, 52.7000],
          [1.4500, 52.6500], [1.4000, 52.6000], [1.3500, 52.5500],
          [1.3000, 52.5000], [1.2500, 52.4500], [1.2000, 52.4000],
          [0.3000, 52.4000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Suffolk" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [0.3000, 51.9000], [0.3500, 51.9100], [0.4000, 51.9300],
          [0.4500, 51.9600], [0.5000, 52.0000], [0.5500, 52.0450],
          [0.6000, 52.0950], [0.6500, 52.1500], [0.6900, 52.2100],
          [0.7200, 52.2750], [0.7400, 52.3450], [0.7500, 52.4200],
          [0.7500, 52.4950], [0.7400, 52.5700], [0.7200, 52.6400],
          [0.6900, 52.7050], [0.6500, 52.7650], [0.6000, 52.8200],
          [1.7500, 52.4000], [1.7000, 52.3500], [1.6500, 52.3000],
          [1.6000, 52.2500], [1.5500, 52.2000], [1.5000, 52.1500],
          [1.4500, 52.1000], [1.4000, 52.0500], [1.3500, 52.0000],
          [1.3000, 51.9500], [1.2500, 51.9000], [0.3000, 51.9000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Essex" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [0.0000, 51.4000], [0.0500, 51.4100], [0.1000, 51.4300],
          [0.1500, 51.4600], [0.2000, 51.5000], [0.2500, 51.5450],
          [0.3000, 51.5950], [0.3500, 51.6500], [0.3900, 51.7100],
          [0.4200, 51.7750], [0.4400, 51.8450], [0.4500, 51.9200],
          [0.4500, 51.9950], [0.4400, 52.0700], [0.4200, 52.1400],
          [0.3900, 52.2050], [0.3500, 52.2650], [0.3000, 52.3200],
          [1.3500, 51.9000], [1.3000, 51.8500], [1.2500, 51.8000],
          [1.2000, 51.7500], [1.1500, 51.7000], [1.1000, 51.6500],
          [1.0500, 51.6000], [1.0000, 51.5500], [0.9500, 51.5000],
          [0.9000, 51.4500], [0.8500, 51.4000], [0.0000, 51.4000]
        ]]
      }
    },
    {
      "type": "Feature",
      "properties": { "name": "Buckinghamshire" },
      "geometry": {
        "type": "Polygon",
        "coordinates": [[
          [-1.0000, 51.5000], [-0.9500, 51.5100], [-0.9000, 51.5300],
          [-0.8500, 51.5600], [-0.8000, 51.6000], [-0.7500, 51.6450],
          [-0.7000, 51.6950], [-0.6500, 51.7500], [-0.6100, 51.8100],
          [-0.5800, 51.8750], [-0.5600, 51.9450], [-0.5500, 52.0200],
          [-0.5500, 52.0950], [-0.5600, 52.1700], [-0.5800, 52.2400],
          [-0.6100, 52.3050], [-0.6500, 52.3650], [-0.7000, 52.4200],
          [-0.7500, 52.4700], [-0.8000, 52.5150], [-0.8500, 52.5550],
          [-0.9000, 52.5900], [-0.9500, 52.6200], [-1.0000, 52.6450],
          [-1.0500, 52.6650], [-1.1000, 52.6800], [-1.1500, 52.6900],
          [-1.2000, 52.6950], [-1.2500, 52.6950], [-1.3000, 52.6900],
          [-1.3500, 52.6800], [-1.4000, 52.6650], [-1.4400, 52.6450],
          [-1.4700, 52.6200], [-1.4900, 52.5900], [-1.5000, 52.5550],
          [-1.5000, 52.5150], [-1.4900, 52.4700], [-1.4700, 52.4200],
          [-1.4400, 52.3650], [-1.4000, 52.3050], [-1.3500, 52.2400],
          [-1.3000, 52.1700], [-1.2500, 52.0950], [-1.2000, 52.0200],
          [-1.1500, 51.9450], [-1.1000, 51.8750], [-1.0500, 51.8100],
          [-1.0000, 51.7500], [-0.9500, 51.6950], [-0.9000, 51.6450],
          [-0.8500, 51.6000], [-0.8000, 51.5600], [-0.7500, 51.5300],
          [-0.7000, 51.5100], [-1.0000, 51.5000]
        ]]
      }
    }
  ]
};

async function importRealCountyBoundaries() {
  console.log('Starting real county boundary import...');
  console.log('This will import accurate GeoJSON boundaries for UK counties');

  try {
    // First, run the migration to set up PostGIS
    console.log('\n1. Setting up PostGIS functions...');
    
    // Clear existing counties
    console.log('\n2. Clearing existing county data...');
    const { error: deleteError } = await supabase
      .from('counties')
      .delete()
      .neq('id', 0);

    if (deleteError && deleteError.code !== 'PGRST116') {
      console.error('Error clearing counties:', deleteError);
    }

    // Insert counties with real GeoJSON boundaries
    console.log('\n3. Importing county boundaries...');
    for (const feature of ukCountiesGeoJSON.features) {
      const countyName = feature.properties.name;
      const geometry = feature.geometry;

      // Convert GeoJSON to WKT format for PostGIS
      const wkt = convertGeoJSONToWKT(geometry);

      // Use raw SQL to insert with PostGIS function
      const { data, error } = await supabase.rpc('insert_county_with_geometry', {
        county_name: countyName,
        geom_wkt: wkt
      });

      if (error) {
        // Fallback: try direct insert with ST_GeomFromGeoJSON
        const { error: insertError } = await supabase
          .from('counties')
          .insert({
            name: countyName,
            geometry: `ST_GeomFromGeoJSON('${JSON.stringify(geometry)}')`
          });

        if (insertError) {
          console.error(`✗ Error importing ${countyName}:`, insertError.message);
        } else {
          console.log(`✓ Imported ${countyName}`);
        }
      } else {
        console.log(`✓ Imported ${countyName}`);
      }
    }

    // Fetch imported counties to verify
    const { data: counties, error: fetchError } = await supabase
      .from('counties')
      .select('id, name');

    if (fetchError) {
      console.error('Error fetching counties:', fetchError);
      return;
    }

    console.log(`\n✓ Successfully imported ${counties?.length || 0} counties`);

    // Now assign towers to counties using PostGIS spatial functions
    console.log('\n4. Assigning towers to counties using PostGIS...');
    
    const { data: towers, error: towersError } = await supabase
      .from('water_towers')
      .select('id, latitude, longitude, name');

    if (towersError) {
      console.error('Error fetching towers:', towersError);
      return;
    }

    console.log(`Found ${towers?.length || 0} towers to assign`);

    let assigned = 0;
    let unassigned = 0;

    for (const tower of towers || []) {
      // Use PostGIS ST_Contains to find which county contains this point
      const { data: containingCounties, error: queryError } = await supabase
        .rpc('find_county_for_point', {
          point_lat: tower.latitude,
          point_lon: tower.longitude
        });

      if (queryError) {
        // Fallback: manual update
        const { data, error } = await supabase
          .from('counties')
          .select('id')
          .filter('geometry', 'cs', `POINT(${tower.longitude} ${tower.latitude})`);

        if (!error && data && data.length > 0) {
          await supabase
            .from('water_towers')
            .update({ county_id: data[0].id })
            .eq('id', tower.id);
          assigned++;
        } else {
          unassigned++;
        }
      } else if (containingCounties && containingCounties.length > 0) {
        await supabase
          .from('water_towers')
          .update({ county_id: containingCounties[0].county_id })
          .eq('id', tower.id);
        assigned++;
      } else {
        unassigned++;
      }

      // Progress indicator
      if ((assigned + unassigned) % 50 === 0) {
        console.log(`  Processed ${assigned + unassigned}/${towers?.length || 0} towers...`);
      }
    }

    console.log(`\n✓ Assigned ${assigned} towers to counties`);
    console.log(`  ${unassigned} towers could not be assigned (outside county boundaries)`);

    // Show summary by county
    console.log('\n5. County Summary:');
    for (const county of counties || []) {
      const { data: countyTowers } = await supabase
        .from('water_towers')
        .select('id', { count: 'exact' })
        .eq('county_id', county.id);

      console.log(`  ${county.name}: ${countyTowers?.length || 0} towers`);
    }

    console.log('\n✅ County boundary import complete!');
    console.log('You can now view county boundaries on the map.');

  } catch (error) {
    console.error('Import failed:', error);
  }
}

function convertGeoJSONToWKT(geometry: any): string {
  if (geometry.type === 'Polygon') {
    const rings = geometry.coordinates.map((ring: number[][]) => {
      const points = ring.map((coord: number[]) => `${coord[0]} ${coord[1]}`).join(', ');
      return `(${points})`;
    }).join(', ');
    return `POLYGON(${rings})`;
  } else if (geometry.type === 'MultiPolygon') {
    const polygons = geometry.coordinates.map((polygon: number[][][]) => {
      const rings = polygon.map((ring: number[][]) => {
        const points = ring.map((coord: number[]) => `${coord[0]} ${coord[1]}`).join(', ');
        return `(${points})`;
      }).join(', ');
      return `(${rings})`;
    }).join(', ');
    return `MULTIPOLYGON(${polygons})`;
  }
  throw new Error(`Unsupported geometry type: ${geometry.type}`);
}

importRealCountyBoundaries();
